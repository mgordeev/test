<?require($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");$APPLICATION->SetPageProperty("title", "Web студия GMsite - Создание качественных сайтов");$APPLICATION->SetPageProperty("NOT_SHOW_NAV_CHAIN", "Y");$APPLICATION->SetTitle("Веб-студия GMsite -полный перечень интернет-услуг");GLOBAL $USER;CModule::IncludeModule("support");?><link rel="stylesheet" href="/bitrix/templates/gm_support_new/components/gmsite/support.ticket.list/gmsite_report/style.css" type="text/css" /><b>Отчет по результатам работы сотрудников</b><br /><?$filter = Array("ACTIVE" => "Y","GROUPS_ID" => Array(7,15));$rsUsers = $USER->GetList(($by="ID"), ($order="asc"), $filter); $gm_employes=array();while($rowUser = $rsUsers->Fetch()){$gm_employes[$rowUser["ID"]]=$rowUser["NAME"].' '.$rowUser["LAST_NAME"].' ('.$rowUser["LOGIN"].')';}$arGroupUsers = array();$arGroupNames = array();$rsData = CSupportUserGroup::GetList(array($by => $order), $arFilter);		while($arRes = $rsData->Fetch()){			$arGroupNames[$arRes["ID"]] = $arRes["NAME"];	$rs_ug = CSupportUser2UserGroup::GetList(false, array('GROUP_ID' => $arRes["ID"]));	while ($ar_ug = $rs_ug->GetNext())	{		$arGroupUsers[$ar_ug['USER_ID']] = $arRes["ID"];	}	}$filter = Array("ACTIVE" => "Y","GROUPS_ID" => Array(9));$rsUsers = $USER->GetList(($by="ID"), ($order="asc"), $filter); $gm_clients=array();while($rowUser = $rsUsers->Fetch()){$group_array=array();if($arGroupUsers[$rowUser["ID"]]>0){$group_array=$arGroupUsers[$rowUser["ID"]];}else{$group_array=$rowUser["WORK_WWW"];}$gm_clients[$group_array][$rowUser["ID"]]["LOGIN"] = $rowUser["LOGIN"];$gm_clients[$group_array][$rowUser["ID"]]["NAME"] = $rowUser["NAME"];$gm_clients[$group_array][$rowUser["ID"]]["LAST_NAME"] = $rowUser["LAST_NAME"];$gm_clients[$group_array][$rowUser["ID"]]["SUPPORT_GROUP"] = $arGroupUsers[$rowUser["ID"]];$gm_clients[$group_array][$rowUser["ID"]]["WORK_WWW"] = $rowUser["WORK_WWW"];}$date_from = date("01.m.Y");if(htmlspecialchars($_GET["date_from"])!=""){$date_from = htmlspecialchars($_GET["date_from"]);}if(htmlspecialchars($_GET["date_to"])!=""){$date_to = htmlspecialchars($_GET["date_to"]);}else{$date_to = date("d.m.Y");}?><form name="show_period">Дата: от  <?$APPLICATION->IncludeComponent(	"bitrix:main.calendar",	"",	Array(		"SHOW_INPUT" => "Y",		"FORM_NAME" => "show_period",		"INPUT_NAME" => "date_from",		"INPUT_NAME_FINISH" => "date_to",		"INPUT_VALUE" => date("d.m.Y",strtotime($date_from)),		"INPUT_VALUE_FINISH" => date("d.m.Y",strtotime($date_to)),		"SHOW_TIME" => "N",		"HIDE_TIMEBAR" => "Y"	),false);?><input type="submit" value="Показать"><a href="clients_excel.php?date_from=<?=$date_from?>&date_to=<?=$date_to?>" target="_blank">Импорт в Excel</a></form> <a href="?date_from=<?=date("d.m.Y", strtotime("last Monday"))?>&date_to=<?=date("d.m.Y")?>">текущая неделя</a> <a href="?date_from=<?=date("d.m.Y",mktime(0,0,0,date("m"), date("d")-7, date("Y")))?>&date_to=<?=date("d.m.Y")?>">последние 7 дней</a> <a href="?date_from=<?=date("d.m.Y",mktime(0,0,0,date("m"), date("d")-30, date("Y")))?>&date_to=<?=date("d.m.Y")?>">последние 30 дней</a><br /><style>.group_clients{background: #A6A6A6;color:#000000;}</style><?foreach($gm_employes as $key_emp=>$value_emp){$count_ticket_emp = 0;$count_ticket_time_emp = 0;echo '<b>'.$value_emp.'</b><br/>';?><table class="support-ticket-list data-table" width="100%">   <tr>  <td>Постановщик</td>  <td>Количество задач</td>  <td>Суммарное время решения</td>  <td>Среднее время решения</td>  <td>Среднее время ожидания <br/> пользователя(разница между<br/> постановкой и закрытием)/<br/>количество задач</td>  <td>Открыто задач</td>  </tr><?//OWNER$old_support_group = 0;foreach($gm_clients as $key_group=>$value_group){$out_group_head = '';$out_group_head_count=0;$out_group_ticket_count=0;$out_group_time_count=0;if($key_group!=""){if(is_int($key_group)){$out_group_head = '<tr><td colspan="6" class="group_clients">'.$arGroupNames[$key_group].'</td></tr>';}else{$out_group_head = '<tr><td colspan="6" class="group_clients">'.$key_group.'</td></tr>';}$out_group_head .='';}foreach($value_group as $key=>$value){//SUPPORT_GROUPif($value["SUPPORT_GROUP"]>0){}?><?$arFilter = Array(		"CLOSE"             => "Y",		"OWNER"             => $key,		"OWNER_EXACT_MATCH"	=> "Y",		//"CREATED_BY"        => $find_created_by,		//"RESPONSIBLE"       => $key_emp,		"RESPONSIBLE_ID"    => $key_emp,		/*"DATE_CLOSE_1"		=> "11.11.2013 00:00:00",		"DATE_CLOSE_2"		=> "15.11.2013 00:00:00",*/		"DATE_TIMESTAMP_1"	=> date("d.m.Y H:i:s",strtotime($date_from)),		"DATE_TIMESTAMP_2"	=> date("d.m.Y H:i:s",strtotime($date_to)),		);				print "<pre>";		//print_r($arFilter);		print "</pre>";$count_tickets=0;$tickets_time=0;$time_waiting = 0;$tickets = CTicket::GetList($by, $order, $arFilter, $is_filtered);while($ar = $tickets->GetNext()){$tickets_time = $tickets_time + $ar["PROBLEM_TIME"];$count_ticket_time_emp = $count_ticket_time_emp + $ar["PROBLEM_TIME"];$time_waiting = $time_waiting + (strtotime($ar["DATE_CLOSE"]) - strtotime($ar["DATE_CREATE"]));$out_group_time_count=$out_group_time_count + $ar["PROBLEM_TIME"];$count_tickets++;$count_ticket_emp++;$out_group_ticket_count++;}if($count_tickets>0){if($key_group==""){?><tr>  <td><?=$value["NAME"].' '.$value["LAST_NAME"].'['.$value["LOGIN"].']'?></td>  <td><?=$count_tickets?></td>  <td><?=$tickets_time?></td>  <td><?=round($tickets_time/$count_tickets,2)?></td>  <td><?=round(($time_waiting/$count_tickets)/60,2)?></td>  <td></td>  </tr>  <?}else{if($out_group_head_count==0){echo $out_group_head;}$out_group_head_count++;?><tr>  <td><?=$value["NAME"].' '.$value["LAST_NAME"].'['.$value["LOGIN"].']'?></td>  <td><?=$count_tickets?></td>  <td><?=$tickets_time?></td>  <td><?=round($tickets_time/$count_tickets,2)?></td>  <td><?=round(($time_waiting/$count_tickets)/60,2)?></td>  <td></td>  </tr><?}}}if($key_group!="" && $out_group_head_count>0){?><tr>  <td>Итого по проекту</td>  <td><?=$out_group_ticket_count?></td>  <td><?=$out_group_time_count?></td>  <td><?=round($out_group_time_count/$out_group_ticket_count,2)?></td>  <td></td>  <td></td>  </tr>  <tr><td colspan="6" class="group_clients">&nbsp;</td></tr><?/*?>  <tr>  <td>Итого</td>  <td><?=$out_group_ticket_count?></td>  <td><?=$out_group_time_count?></td>  <td><?=round($out_group_time_count/$out_group_ticket_count,2)?></td>  <td></td>  <td></td>  </tr></table><br /><br /><br /><?*/}}?><tr>  <td><b>Итого</b></td>  <td><b><?=$count_ticket_emp?></b></td>  <td><b><?=$count_ticket_time_emp?></b></td>  <td><b><?=round($out_group_time_count/$out_group_ticket_count,2)?></b></td>  <td></td>  <td></td>  </tr></table><br /><br /><br /><?}?>     <?require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");?>