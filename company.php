<?require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/header.php");$APPLICATION->SetPageProperty("title", "Отчет по результатам работы компании");$APPLICATION->SetPageProperty("NOT_SHOW_NAV_CHAIN", "Y");$APPLICATION->SetTitle("Отчет по результатам работы компании");GLOBAL $USER;CModule::IncludeModule("support");?>    <link rel="stylesheet" href="/bitrix/templates/gm_support_new/components/gmsite/support.ticket.list/gmsite_report/style.css" type="text/css"/>    <b>Отчет по результатам работы компании</b><br/><?$filter = Array("ACTIVE" => "Y", "GROUPS_ID" => Array(7, 15)); // администраторы и сотрудники ТП$rsUsers = $USER->GetList(($by = "ID"), ($order = "asc"), $filter);$gm_employes = array();while ($rowUser = $rsUsers->Fetch()) {    $gm_employes[$rowUser["ID"]] = $rowUser["NAME"] . ' ' . $rowUser["LAST_NAME"] . ' (' . $rowUser["LOGIN"] . ')';}$date_from = date("01.m.Y"); // Обработка датif (htmlspecialchars($_GET["date_from"]) != "") {    $date_from = htmlspecialchars($_GET["date_from"]);}if (htmlspecialchars($_GET["date_to"]) != "") {    $date_to = htmlspecialchars($_GET["date_to"]);} else {    $date_to = date("d.m.Y");}?>    <form name="show_period">        Дата: от  <?$APPLICATION->IncludeComponent(            "bitrix:main.calendar",            "",            Array(                "SHOW_INPUT"         => "Y",                "FORM_NAME"          => "show_period",                "INPUT_NAME"         => "date_from",                "INPUT_NAME_FINISH"  => "date_to",                "INPUT_VALUE"        => date("d.m.Y", strtotime($date_from)),                "INPUT_VALUE_FINISH" => date("d.m.Y", strtotime($date_to)),                "SHOW_TIME"          => "N",                "HIDE_TIMEBAR"       => "Y"            ),            false        );?>        <br />        Группировать по        <select name="group_by">            <option value="day">Дням</option            <option value="week" selected="selected">Неделям</option>            <option value="month">Месяцам</option>        </select>        <br />        Ответственный <select name="responsible">            <option value="0" selected="selected"></option>            <?foreach($gm_employes as $k=>$v):?>            <option value="<?=$k?>"><?=$v?></option>            <?endforeach;?>        </select>        <input type="submit" name="submit" value="Показать">    </form><!--    <a href="?date_from=<?= date("d.m.Y", strtotime("last Monday")) ?>&date_to=<?= date("d.m.Y") ?>">текущая неделя</a>    <a href="?date_from=<?= date("d.m.Y", mktime(0, 0, 0, date("m"), date("d") - 7, date("Y"))) ?>&date_to=<?= date("d.m.Y") ?>">последние        7 дней</a>    <a href="?date_from=<?= date("d.m.Y", mktime(0, 0, 0, date("m"), date("d") - 30, date("Y"))) ?>&date_to=<?= date("d.m.Y") ?>">последние        30 дней</a>    <br/>--><?// В зависимости от POST формируем фильтрif (!isset($_POST["submit"])){ // формируем дефолтный фильтр    $arFilter = Array(        "CLOSE"             => "Y",        "OWNER_EXACT_MATCH" => "Y",        "DATE_CLOSE_1"  => date("d.m.Y H:i:s", strtotime($date_from)),        "DATE_CLOSE_2"  => date("d.m.Y H:i:s", strtotime($date_to)),    );} else {    $arFilter = Array(        "CLOSE"             => "Y",        "OWNER_EXACT_MATCH" => "Y",        "DATE_CLOSE_1"  => date("d.m.Y H:i:s", strtotime($date_from)),        "DATE_CLOSE_2"  => date("d.m.Y H:i:s", strtotime($date_to)),    );    if (intval($_POST["responsible"])>0){        $arFilter["RESPONSIBLE"] = $_POST["responsible"];    }}// получаем все периоды$perionds = array();if (!isset($_POST["group_by"])){    $sec = 7;} else {    switch($_POST["group_by"]){        case 'day':            $sec = 1;            break;        case 'week':            $sec = 7;            break;        case 'month':            $sec=30;            break;    }}$ttt = strtotime($date_from);while($ttt<=strtotime($date_to)){    //   $cnt++;    $dt = date("Y-m-d", $ttt);    //   $total+=$tasks[$dt];    ?>    <tr>        <td><?=date("d.m.Y", $ttt)?></td>        <?        foreach($gm_employes as $k=>$v){            $total_resp[$k]+=$resp_tasks[$k][$dt];            ?>            <td><?=round($resp_tasks[$k][$dt]/60, 2)?></td>        <?        }        ?>        <td><?=round($all_tasks[$dt]/60, 2)?></td>    </tr>    <?    $ttt+=86400;}// получаем все задачи$tickets = CTicket::GetList($by, $order, $arFilter, $is_filtered);while ($ar = $tickets->GetNext()) {    $tickets_time = $tickets_time + $ar["PROBLEM_TIME"];    $count_ticket_time_emp = $count_ticket_time_emp + $ar["PROBLEM_TIME"];    $time_waiting = $time_waiting + (strtotime($ar["DATE_CLOSE"]) - strtotime($ar["DATE_CREATE"]));    $out_group_time_count = $out_group_time_count + $ar["PROBLEM_TIME"];    $count_tickets++;    $count_ticket_emp++;    $out_group_ticket_count++;}?><? require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php"); ?>